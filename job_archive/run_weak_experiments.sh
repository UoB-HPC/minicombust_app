#!/bin/bash

export LD_LIBRARY_PATH=/lustre/fsw/coreai_devtech_all/hwaugh/repos/AMGX/install/lib/:$LD_LIBRARY_PATH

for x in {79,100,126,159,200,252,318,401,505}
do
	echo "RUNNING EXPERIMENT with $x CELLS"
	export MINICOMBUST_GPUS=8
	export MINICOMBUST_RANKS=112
	export MINICOMBUST_PRANKS=$(( MINICOMBUST_RANKS - MINICOMBUST_GPUS ))
	export MINICOMBUST_CELLS=$x
	export MINICOMBUST_PARTICLES=80000
	export MINICOMBUST_ITERS=100

	echo ""	
  	echo "MINICOMBUST_GPUS      $MINICOMBUST_GPUS "
	echo "MINICOMBUST_RANKS     $MINICOMBUST_RANKS "
	echo "MINICOMBUST_PRANKS    $MINICOMBUST_PRANKS "
	echo "MINICOMBUST_CELLS     $MINICOMBUST_CELLS "
	echo "MINICOMBUST_PARTICLES $MINICOMBUST_PARTICLES "
	echo "MINICOMBUST_ITERS     $MINICOMBUST_ITERS "	
	echo ""		

	cmd="mpirun -np $MINICOMBUST_RANKS ./wrapper.sh ./bin/gpu_minicombust $MINICOMBUST_PRANKS $MINICOMBUST_PARTICLES $MINICOMBUST_CELLS -1 $MINICOMBUST_ITERS"
	filename="WEAK-RANKS$MINICOMBUST_RANKS-GPUS$MINICOMBUST_GPUS-CELLS$MINICOMBUST_CELLS-PARTICLES-$MINICOMBUST_PARTICLES-ITERS$MINICOMBUST_ITERS.log"
	echo "$cmd"
	echo "$filename"
	OMPI_ALLOW_RUN_AS_ROOT=1 OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1 $cmd | tee $filename
done


